name: Send Advent Email

on:
  schedule:
    # Runs every day at 7:30 AM Melbourne time (20:30 UTC previous day)
    # To change time: Update the cron expression below
    # Examples: 
    #   "0 21 * * *"  = 8:00 AM Melbourne (21:00 UTC previous day)
    #   "30 21 * * *" = 8:30 AM Melbourne (21:30 UTC previous day)
    #   "0 22 * * *"  = 9:00 AM Melbourne (22:00 UTC previous day)
    - cron: "30 20 * * *"
  workflow_dispatch:
    inputs:
      test_date:
        description: 'Override date for testing (YYYY-MM-DD format, leave empty for today)'
        required: false
        type: string
      dry_run:
        description: 'Dry run - show what would be sent without actually sending'
        required: false
        type: boolean
        default: false

jobs:
  send-email:
    runs-on: ubuntu-latest
    env:
      TZ: Australia/Melbourne
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        run: npm install

      - name: Send today's advent email
        run: npm run send-today
        env:
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASS: ${{ secrets.SMTP_PASS }}
          SMTP_SECURE: ${{ secrets.SMTP_SECURE }}
          FRIEND_EMAIL: ${{ secrets.FRIEND_EMAIL }}
          FROM_EMAIL: ${{ secrets.FROM_EMAIL }}
          FROM_NAME: ${{ secrets.FROM_NAME }}
          TEST_DATE: ${{ github.event.inputs.test_date }}
          DRY_RUN: ${{ github.event.inputs.dry_run }}
