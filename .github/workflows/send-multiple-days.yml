name: Send Multiple Advent Days

on:
  workflow_dispatch:
    inputs:
      days_to_send:
        description: 'Comma-separated list of days to send (e.g., 1,2,3 or 1-3)'
        required: true
        type: string
        default: '1,2,3'
      start_time:
        description: 'When to start sending (HH:MM in Melbourne time, leave empty for immediate)'
        required: false
        type: string
        default: ''
      delay_between_sends:
        description: 'Delay between emails in seconds (to avoid spam filters)'
        required: false
        type: number
        default: 30
      dry_run:
        description: 'Dry run - show what would be sent without actually sending'
        required: false
        type: boolean
        default: false

jobs:
  send-multiple-days:
    runs-on: ubuntu-latest
    env:
      TZ: Australia/Melbourne
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        run: npm install

      - name: Parse and send multiple days
        run: |
          # Check if start time is specified
          START_TIME="${{ github.event.inputs.start_time }}"
          
          if [ -n "$START_TIME" ]; then
            echo "‚è∞ Start time specified: $START_TIME Melbourne time"
            
            # Get current Melbourne time
            CURRENT_TIME=$(TZ=Australia/Melbourne date +%H:%M)
            CURRENT_HOUR=$(TZ=Australia/Melbourne date +%H)
            CURRENT_MIN=$(TZ=Australia/Melbourne date +%M)
            
            # Parse target time (remove leading zeros to avoid octal interpretation)
            TARGET_HOUR=$(echo $START_TIME | cut -d':' -f1 | sed 's/^0*//')
            TARGET_MIN=$(echo $START_TIME | cut -d':' -f2 | sed 's/^0*//')
            
            # Handle empty strings (when removing 0 from "00")
            if [ -z "$TARGET_HOUR" ]; then TARGET_HOUR=0; fi
            if [ -z "$TARGET_MIN" ]; then TARGET_MIN=0; fi
            if [ -z "$CURRENT_HOUR" ]; then CURRENT_HOUR=0; fi
            if [ -z "$CURRENT_MIN" ]; then CURRENT_MIN=0; fi
            
            # Remove leading zeros from current time too
            CURRENT_HOUR=$(echo $CURRENT_HOUR | sed 's/^0*//')
            CURRENT_MIN=$(echo $CURRENT_MIN | sed 's/^0*//')
            if [ -z "$CURRENT_HOUR" ]; then CURRENT_HOUR=0; fi
            if [ -z "$CURRENT_MIN" ]; then CURRENT_MIN=0; fi
            
            # Convert to minutes since midnight for comparison
            CURRENT_TOTAL_MIN=$((CURRENT_HOUR * 60 + CURRENT_MIN))
            TARGET_TOTAL_MIN=$((TARGET_HOUR * 60 + TARGET_MIN))
            
            echo "üìÖ Current Melbourne time: $CURRENT_TIME (${CURRENT_HOUR}:${CURRENT_MIN} = ${CURRENT_TOTAL_MIN} min)"
            echo "üéØ Target start time: $START_TIME (${TARGET_HOUR}:${TARGET_MIN} = ${TARGET_TOTAL_MIN} min)"
            
            if [ $CURRENT_TOTAL_MIN -lt $TARGET_TOTAL_MIN ]; then
              WAIT_MIN=$((TARGET_TOTAL_MIN - CURRENT_TOTAL_MIN))
              echo "‚è≥ Waiting $WAIT_MIN minutes until start time..."
              echo "‚è≥ Sleep command: sleep $((WAIT_MIN * 60)) seconds"
              sleep $((WAIT_MIN * 60))
              echo "‚úÖ Wait completed! Starting now..."
            elif [ $CURRENT_TOTAL_MIN -gt $TARGET_TOTAL_MIN ]; then
              echo "‚ö†Ô∏è  Start time ($START_TIME) has already passed today. Starting immediately."
            else
              echo "‚úÖ It's exactly the right time! Starting now."
            fi
          else
            echo "üöÄ No start time specified. Starting immediately."
          fi
          
          # Parse the input days
          DAYS_INPUT="${{ github.event.inputs.days_to_send }}"
          DELAY="${{ github.event.inputs.delay_between_sends }}"
          
          echo "üîß Input days: $DAYS_INPUT"
          
          # Expand ranges and create final day list
          EXPANDED_DAYS=""
          
          # Split by comma and process each item
          IFS=',' read -ra DAY_ITEMS <<< "$(echo $DAYS_INPUT | sed 's/[[:space:]]//g')"
          for item in "${DAY_ITEMS[@]}"; do
            if [[ $item =~ ^[0-9]+-[0-9]+$ ]]; then
              # Handle range like "1-3"
              start=$(echo $item | cut -d'-' -f1)
              end=$(echo $item | cut -d'-' -f2)
              for day in $(seq $start $end); do
                if [ -z "$EXPANDED_DAYS" ]; then
                  EXPANDED_DAYS="$day"
                else
                  EXPANDED_DAYS="$EXPANDED_DAYS,$day"
                fi
              done
            else
              # Handle single day
              if [ -z "$EXPANDED_DAYS" ]; then
                EXPANDED_DAYS="$item"
              else
                EXPANDED_DAYS="$EXPANDED_DAYS,$item"
              fi
            fi
          done
          
          echo "üìÖ Expanded days: $EXPANDED_DAYS"
          echo "‚è±Ô∏è Delay between sends: ${DELAY} seconds"
          echo "üîç Dry run mode: ${{ github.event.inputs.dry_run }}"
          echo ""
          
          # Convert comma-separated days to array for processing
          IFS=',' read -ra DAYS_TO_SEND <<< "$EXPANDED_DAYS"
          TOTAL=${#DAYS_TO_SEND[@]}
          
          # Convert days to dates and send emails
          CURRENT_YEAR=$(date +%Y)
          COUNT=0
          
          for DAY in "${DAYS_TO_SEND[@]}"; do
            # Skip empty values
            if [ -z "$DAY" ]; then
              continue
            fi
            
            COUNT=$((COUNT + 1))
            
            # Format day with leading zero
            DAY_FORMATTED=$(printf "%02d" $DAY)
            TEST_DATE="${CURRENT_YEAR}-12-${DAY_FORMATTED}"
            
            echo "üìß [$COUNT/$TOTAL] Sending Day $DAY (${TEST_DATE})..."
            
            # Send the email with proper environment variables
            TEST_DATE="$TEST_DATE" TEST_DATE_OVERRIDE="true" npm run send-today
            
            # Add delay between emails (except for the last one)
            if [ $COUNT -lt $TOTAL ]; then
              echo "‚è≥ Waiting ${DELAY} seconds before next email..."
              sleep $DELAY
              echo ""
            fi
            
          done
          
          echo "‚úÖ Completed sending $COUNT advent emails!"
          
        env:
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASS: ${{ secrets.SMTP_PASS }}
          SMTP_SECURE: ${{ secrets.SMTP_SECURE }}
          FRIEND_EMAIL: ${{ secrets.FRIEND_EMAIL }}
          FROM_EMAIL: ${{ secrets.FROM_EMAIL }}
          FROM_NAME: ${{ secrets.FROM_NAME }}
          DRY_RUN: ${{ github.event.inputs.dry_run }}
          TEST_DATE_OVERRIDE: "true"